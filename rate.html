<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Gold Rates</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #fdf6f0;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}
.container {
  width: 95%;
  max-width: 800px;
  background: #fff;
  border-radius: 15px;
  margin-top: 30px;
  padding: 25px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}
h1 {
  color: #b8860b;
  margin-bottom: 10px;
  font-size: 2em;
}
.ounce-rate {
  font-size: 2em;
  font-weight: bold;
  color: #b8860b;
  margin-bottom: 20px;
}
.rates {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
  margin-bottom: 20px;
}
.rate-card {
  background: #faf9f6;
  padding: 15px 20px;
  margin: 8px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  flex: 1 1 45%;
  min-width: 120px;
  text-align: center;
}
.rate-card h3 {
  margin: 0;
  font-size: 1.1em;
  color: #555;
}
.rate-card p {
  margin: 5px 0 0;
  font-size: 1.2em;
  font-weight: bold;
  color: #222;
}
.chart-container {
  margin-top: 25px;
}
.chart-container canvas {
  width: 100% !important;
  max-height: 300px;
}
.timeframe-buttons {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}
.timeframe-buttons button {
  background: #b8860b;
  color: #fff;
  border: none;
  padding: 8px 16px;
  margin: 0 5px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.3s;
}
.timeframe-buttons button:hover {
  background: #a0760a;
}
.timestamp {
  text-align: center;
  color: #666;
  font-size: 0.9em;
  margin-top: 8px;
}
@media (max-width: 500px) {
  .rates {
    flex-direction: column;
    align-items: center;
  }
  .rate-card {
    flex: 1 1 90%;
  }
}
</style>
</head>
<body>
<div class="container">
  <h1>Live Gold Rates</h1>
  <div class="ounce-rate" id="ounceRate">Loading...</div>

  <div class="rates">
    <div class="rate-card">
      <h3>24K</h3>
      <p id="rate24">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>22K</h3>
      <p id="rate22">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>21K</h3>
      <p id="rate21">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>18K</h3>
      <p id="rate18">Loading...</p>
    </div>
  </div>

  <div class="timestamp" id="timestamp">Last updated: --</div>

  <div class="chart-container">
    <canvas id="goldChart"></canvas>
    <div class="timeframe-buttons">
      <button onclick="changeTimeframe('10m')">10m</button>
      <button onclick="changeTimeframe('1h')">1h</button>
      <button onclick="changeTimeframe('1d')">1d</button>
    </div>
  </div>
</div>

<script>
let goldHistory = [];
let chart;
let timeframe = '10m';
const USD_TO_KWD = 0.31;

function calculatePurities(price24k) {
  return {
    '24K': price24k,
    '22K': price24k * 22/24,
    '21K': price24k * 21/24,
    '18K': price24k * 18/24
  };
}

async function fetchGold() {
  try {
    const res = await fetch("https://api.gold-api.com/price/XAU");
    const data = await res.json();

    const pricePerOunce = data.price;
    const pricePerGram = pricePerOunce / 31.1035;
    const purities = calculatePurities(pricePerGram);

    document.getElementById("ounceRate").innerText = `$${pricePerOunce.toFixed(2)} / oz`;

    document.getElementById("rate24").innerText = `${(purities['24K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate22").innerText = `${(purities['22K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate21").innerText = `${(purities['21K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate18").innerText = `${(purities['18K']*USD_TO_KWD).toFixed(3)} KWD/g`;

    document.getElementById("timestamp").innerText = "Last updated: " + data.updatedAtReadable;

    const now = new Date();
    goldHistory.push({time: now, purities});
    if (goldHistory.length > 1000) goldHistory.shift();

    updateChart();
  } catch (err) {
    console.error(err);
  }
}

function initChart() {
  const ctx = document.getElementById('goldChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: goldHistory.map(d => d.time.toLocaleTimeString()),
      datasets: [
        { label: '24K', data: goldHistory.map(d => d.purities['24K']*USD_TO_KWD), borderColor: '#b8860b', fill: false, tension:0.3 },
        { label: '22K', data: goldHistory.map(d => d.purities['22K']*USD_TO_KWD), borderColor: '#888', fill: false, tension:0.3 },
        { label: '21K', data: goldHistory.map(d => d.purities['21K']*USD_TO_KWD), borderColor: '#4caf50', fill: false, tension:0.3 },
        { label: '18K', data: goldHistory.map(d => d.purities['18K']*USD_TO_KWD), borderColor: '#2196f3', fill: false, tension:0.3 }
      ]
    },
    options: {
      responsive: true,
      animation: { duration: 1000 },
      scales: {
        x: { display: true, title: { display: true, text: 'Time' } },
        y: { display: true, title: { display: true, text: 'Price (KWD/g)' } }
      },
      plugins: { legend: { position: 'top' } }
    }
  });
}

function updateChart() {
  if(!chart) initChart();

  const now = new Date();
  let filtered = goldHistory;
  if(timeframe === '10m') filtered = goldHistory.filter(d => now - d.time <= 10*60*1000);
  if(timeframe === '1h') filtered = goldHistory.filter(d => now - d.time <= 60*60*1000);
  if(timeframe === '1d') filtered = goldHistory.filter(d => now - d.time <= 24*60*60*1000);

  chart.data.labels = filtered.map(d => d.time.toLocaleTimeString());
  chart.data.datasets[0].data = filtered.map(d => d.purities['24K']*USD_TO_KWD);
  chart.data.datasets[1].data = filtered.map(d => d.purities['22K']*USD_TO_KWD);
  chart.data.datasets[2].data = filtered.map(d => d.purities['21K']*USD_TO_KWD);
  chart.data.datasets[3].data = filtered.map(d => d.purities['18K']*USD_TO_KWD);
  chart.update();
}

function changeTimeframe(tf) {
  timeframe = tf;
  updateChart();
}

fetchGold();
initChart();
setInterval(fetchGold, 10000);
setInterval(updateChart, 1000);