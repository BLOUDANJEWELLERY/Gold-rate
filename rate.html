<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Gold Rates</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #fdf6f0;
    color: #333;
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .container {
    width: 100%;
    max-width: 800px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    padding: 30px;
  }

  h1 {
    color: #b8860b;
    text-align: center;
    margin-bottom: 10px;
  }

  .ounce-rate {
    text-align: center;
    font-size: 2em;
    font-weight: bold;
    color: #b8860b;
    margin-bottom: 25px;
  }

  .rates {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin-bottom: 25px;
  }

  .rate-card {
    background: #faf9f6;
    flex: 1 1 45%;
    min-width: 120px;
    margin: 10px;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    text-align: center;
  }

  .rate-card h3 {
    margin: 0;
    font-size: 1.1em;
    color: #555;
  }

  .rate-card p {
    margin: 8px 0 0;
    font-size: 1.2em;
    font-weight: bold;
    color: #222;
  }

  .timestamp {
    text-align: center;
    color: #666;
    font-size: 0.9em;
    margin-bottom: 20px;
  }

  .chart-container {
    width: 100%;
    margin-top: 20px;
  }

  .timeframe-buttons {
    display: flex;
    justify-content: center;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .timeframe-buttons button {
    background: #b8860b;
    color: #fff;
    border: none;
    padding: 8px 16px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    transition: 0.3s;
  }

  .timeframe-buttons button:hover {
    background: #a0760a;
  }

  @media (max-width: 500px) {
    .rates {
      flex-direction: column;
      align-items: center;
    }
    .rate-card {
      flex: 1 1 90%;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>Live Gold Rates</h1>
  <div class="ounce-rate" id="ounceRate">Loading...</div>

  <div class="rates">
    <div class="rate-card">
      <h3>24K</h3>
      <p id="rate24">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>22K</h3>
      <p id="rate22">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>21K</h3>
      <p id="rate21">Loading...</p>
    </div>
    <div class="rate-card">
      <h3>18K</h3>
      <p id="rate18">Loading...</p>
    </div>
  </div>

  <div class="timestamp" id="timestamp">Last updated: --</div>

  <div class="chart-container">
    <canvas id="goldChart"></canvas>
    <div class="timeframe-buttons">
      <button onclick="changeTimeframe('10m')">10m</button>
      <button onclick="changeTimeframe('1h')">1h</button>
      <button onclick="changeTimeframe('1d')">1d</button>
    </div>
  </div>
</div>

<script>
let USD_TO_KWD = 0.31;
let goldHistory = [];
let chart;
let timeframe = '10m';

function calculatePurities(pricePerGram) {
  return {
    '24K': pricePerGram,
    '22K': pricePerGram * 22/24,
    '21K': pricePerGram * 21/24,
    '18K': pricePerGram * 18/24
  };
}

async function fetchUSDToKWD() {
  try {
    const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const data = await res.json();
    if (data && data.rates && data.rates.KWD) {
      USD_TO_KWD = data.rates.KWD + 0.002;
      console.log("USD/KWD rate:", USD_TO_KWD);
    }
  } catch(err) {
    console.error("Error fetching USD/KWD:", err);
  }
}

async function fetchGold() {
  try {
    const res = await fetch("https://api.gold-api.com/price/XAU");
    const data = await res.json();
    const pricePerOunce = data.price;
    const pricePerGram = pricePerOunce / 31.1035;
    const purities = calculatePurities(pricePerGram);

    // Update display
    document.getElementById("ounceRate").innerText = `$${pricePerOunce.toFixed(2)} / oz`;
    document.getElementById("rate24").innerText = `${(purities['24K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate22").innerText = `${(purities['22K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate21").innerText = `${(purities['21K']*USD_TO_KWD).toFixed(3)} KWD/g`;
    document.getElementById("rate18").innerText = `${(purities['18K']*USD_TO_KWD).toFixed(3)} KWD/g`;

    document.getElementById("timestamp").innerText = "Last updated: " + data.updatedAtReadable;

    // Add to history
    const now = new Date();
    goldHistory.push({ time: now, purities });
    if (goldHistory.length > 1000) goldHistory.shift();

    updateChart();
  } catch(err) {
    console.error("Error fetching gold data:", err);
  }
}

function initChart() {
  const ctx = document.getElementById('goldChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: goldHistory.map(d => d.time.toLocaleTimeString()),
      datasets: [
        { label: '24K', data: goldHistory.map(d => d.purities['24K']*USD_TO_KWD), borderColor: '#b8860b', fill: false, tension:0.3 },
        { label: '22K', data: goldHistory.map(d => d.purities['22K']*USD_TO_KWD), borderColor: '#888', fill: false, tension:0.3 },
        { label: '21K', data: goldHistory.map(d => d.purities['21K']*USD_TO_KWD), borderColor: '#4caf50', fill: false, tension:0.3 },
        { label: '18K', data: goldHistory.map(d => d.purities['18K']*USD_TO_KWD), borderColor: '#2196f3', fill: false, tension:0.3 }
      ]
    },
    options: {
      responsive: true,
      animation: { duration: 1000 },
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { title: { display: true, text: 'Price (KWD/g)' } }
      },
      plugins: { legend: { position: 'top' } }
    }
  });
}

function updateChart() {
  if (!chart) initChart();

  const now = new Date();
  let filtered = goldHistory;
  if (timeframe === '10m') filtered = goldHistory.filter(d => now - d.time <= 10*60*1000);
  if (timeframe === '1h') filtered = goldHistory.filter(d => now - d.time <= 60*60*1000);
  if (timeframe === '1d') filtered = goldHistory.filter(d => now - d.time <= 24*60*60*1000);

  chart.data.labels = filtered.map(d => d.time.toLocaleTimeString());
  chart.data.datasets[0].data = filtered.map(d => d.purities['24K']*USD_TO_KWD);
  chart.data.datasets[1].data = filtered.map(d => d.purities['22K']*USD_TO_KWD);
  chart.data.datasets[2].data = filtered.map(d => d.purities['21K']*USD_TO_KWD);
  chart.data.datasets[3].data = filtered.map(d => d.purities['18K']*USD_TO_KWD);
  chart.update();
}

function changeTimeframe(tf) {
  timeframe = tf;
  updateChart();
}

// Initial load
fetchUSDToKWD().then(() => {
  fetchGold();
  initChart();
  setInterval(fetchUSDToKWD, 600000); // update USD/KWD every 10 min
  setInterval(fetchGold, 10000);       // fetch gold every 10 sec
  setInterval(updateChart, 1000);      // smooth chart update
});
</script>

</body>
</html>